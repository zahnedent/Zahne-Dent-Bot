<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZahnDent - Business Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-center mb-4">
                    <div class="bg-blue-600 rounded-full p-3 mr-3">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800">ZahnDent</h1>
                </div>
                <h2 class="text-xl text-gray-600 mb-2">Dental Distributor Verification Portal</h2>
                <p class="text-gray-500">Secure Business Verification System</p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-md mx-auto">
            <div id="verification-card" class="bg-white rounded-lg shadow-lg p-6">
                <!-- Business Info Form -->
                <div id="business-form" class="space-y-4">
                    <div class="text-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800" id="business-registration-title">Business Registration</h2>
                        <p class="text-gray-600 text-sm" id="provide-info-text">Please provide your business information (optional)</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" id="business-name-label">Business Name</label>
                        <input type="text" id="business-name" placeholder="Enter your business name"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" id="country-label">Country</label>
                        <select id="country" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" id="country-select">Select your country</option>
                            <option value="Syria" id="country-syria">Syria</option>
                            <option value="Saudi Arabia" id="country-saudi">Saudi Arabia</option>
                            <option value="UAE" id="country-uae">United Arab Emirates</option>
                            <option value="Jordan" id="country-jordan">Jordan</option>
                            <option value="Lebanon" id="country-lebanon">Lebanon</option>
                            <option value="Iraq" id="country-iraq">Iraq</option>
                            <option value="Egypt" id="country-egypt">Egypt</option>
                            <option value="Turkey" id="country-turkey">Turkey</option>
                            <option value="Other" id="country-other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" id="email-label">Email Address</label>
                        <input type="email" id="email" placeholder="your.email@example.com"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="flex space-x-3 pt-4">
                        <button id="skip-btn" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 transition duration-200">
                            Skip
                        </button>
                        <button id="continue-btn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
                            Continue
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="hidden text-center">
                    <div class="spinner mx-auto mb-4"></div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2" id="verifying-location-title">Verifying Business Location...</h3>
                    <p class="text-gray-500 text-sm" id="please-wait-text">Please wait while we verify your location</p>
                </div>

                <!-- Success State -->
                <div id="success-state" class="hidden text-center">
                    <div class="bg-green-100 rounded-full p-3 mx-auto mb-4 w-fit">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-green-700 mb-2" id="registration-successful-title">Registration Successful!</h3>
                    <p class="text-gray-600 text-sm" id="business-registered-text">Your business has been successfully registered</p>
                </div>

                <!-- Error State -->
                <div id="error-state" class="hidden text-center">
                    <div class="bg-red-100 rounded-full p-3 mx-auto mb-4 w-fit">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-red-700 mb-2" id="registration-failed-title">Registration Failed</h3>
                    <p class="text-gray-600 text-sm" id="unable-to-complete-text">We were unable to complete your business registration.</p>
                    <p class="text-gray-500 text-xs mt-2" id="enable-location-text">Please enable location services and try again.</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center mt-6">
                <p class="text-gray-500 text-sm">© 2024 ZahnDent. All rights reserved.</p>
            </div>
        </div>
    </div>

    <script>
        // Telegram WebApp initialization
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        // DOM elements
        const businessForm = document.getElementById('business-form');
        const loadingState = document.getElementById('loading-state');
        const successState = document.getElementById('success-state');
        const errorState = document.getElementById('error-state');

        // Form elements
        const businessNameInput = document.getElementById('business-name');
        const countrySelect = document.getElementById('country');
        const emailInput = document.getElementById('email');
        const skipBtn = document.getElementById('skip-btn');
        const continueBtn = document.getElementById('continue-btn');

        // Language support for Mini App
        const miniAppTexts = {
            en: {
                businessRegistration: 'Business Registration',
                provideInfo: 'Please provide your business information (optional)',
                businessName: 'Business Name',
                country: 'Country',
                email: 'Email Address',
                skip: 'Skip',
                continue: 'Continue',
                verifyingLocation: 'Verifying Business Location...',
                pleaseWait: 'Please wait while we verify your location',
                registrationSuccessful: 'Registration Successful!',
                businessRegistered: 'Your business has been successfully registered',
                registrationFailed: 'Registration Failed',
                unableToComplete: 'We were unable to complete your business registration.',
                enableLocation: 'Please ensure location services are enabled and try again.',
                selectCountry: 'Select your country',
                syria: 'Syria',
                saudiArabia: 'Saudi Arabia',
                uae: 'United Arab Emirates',
                jordan: 'Jordan',
                lebanon: 'Lebanon',
                iraq: 'Iraq',
                egypt: 'Egypt',
                turkey: 'Turkey',
                other: 'Other'
            },
            ar: {
                businessRegistration: 'تسجيل العمل',
                provideInfo: 'يرجى تقديم معلومات عملك (اختياري)',
                businessName: 'اسم العمل',
                country: 'البلد',
                email: 'عنوان البريد الإلكتروني',
                skip: 'تخطي',
                continue: 'متابعة',
                verifyingLocation: 'جاري التحقق من موقع العمل...',
                pleaseWait: 'يرجى الانتظار أثناء التحقق من موقعك',
                registrationSuccessful: 'تم التسجيل بنجاح!',
                businessRegistered: 'تم تسجيل عملك بنجاح',
                registrationFailed: 'فشل التسجيل',
                unableToComplete: 'لم نتمكن من إكمال تسجيل عملك.',
                enableLocation: 'يرجى التأكد من تمكين خدمات الموقع والمحاولة مرة أخرى.',
                selectCountry: 'اختر بلدك',
                syria: 'سوريا',
                saudiArabia: 'المملكة العربية السعودية',
                uae: 'الإمارات العربية المتحدة',
                jordan: 'الأردن',
                lebanon: 'لبنان',
                iraq: 'العراق',
                egypt: 'مصر',
                turkey: 'تركيا',
                other: 'أخرى'
            }
        };

        // Get language from URL parameter
        function getLanguageFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            // Default to Arabic for unsupported languages
            if (!lang || !miniAppTexts[lang]) {
                return 'ar';
            }
            return lang;
        }

        // Current language
        const currentLang = getLanguageFromUrl();
        const texts = miniAppTexts[currentLang] || miniAppTexts.ar;

        // Business data storage
        let businessData = {
            businessName: '',
            country: '',
            email: ''
        };

        // Apply translations to the page
        function applyTranslations() {
            // Business form translations
            document.getElementById('business-registration-title').textContent = texts.businessRegistration;
            document.getElementById('provide-info-text').textContent = texts.provideInfo;
            document.getElementById('business-name-label').textContent = texts.businessName;
            document.getElementById('country-label').textContent = texts.country;
            document.getElementById('email-label').textContent = texts.email;
            document.getElementById('skip-btn').textContent = texts.skip;
            document.getElementById('continue-btn').textContent = texts.continue;

            // Loading state translations
            document.getElementById('verifying-location-title').textContent = texts.verifyingLocation;
            document.getElementById('please-wait-text').textContent = texts.pleaseWait;

            // Success state translations
            document.getElementById('registration-successful-title').textContent = texts.registrationSuccessful;
            document.getElementById('business-registered-text').textContent = texts.businessRegistered;

            // Error state translations
            document.getElementById('registration-failed-title').textContent = texts.registrationFailed;
            document.getElementById('unable-to-complete-text').textContent = texts.unableToComplete;
            document.getElementById('enable-location-text').textContent = texts.enableLocation;

            // Update placeholders
            businessNameInput.placeholder = texts.businessName === 'Business Name' ? 'Enter your business name' :
                                          texts.businessName === 'اسم العمل' ? 'أدخل اسم عملك' : 'Enter your business name';
            emailInput.placeholder = currentLang === 'ar' ? 'بريدك@example.com' : 'your.email@example.com';

            // Update country dropdown options
            document.getElementById('country-select').textContent = texts.selectCountry || 'Select your country';
            document.getElementById('country-syria').textContent = texts.syria || 'Syria';
            document.getElementById('country-saudi').textContent = texts.saudiArabia || 'Saudi Arabia';
            document.getElementById('country-uae').textContent = texts.uae || 'United Arab Emirates';
            document.getElementById('country-jordan').textContent = texts.jordan || 'Jordan';
            document.getElementById('country-lebanon').textContent = texts.lebanon || 'Lebanon';
            document.getElementById('country-iraq').textContent = texts.iraq || 'Iraq';
            document.getElementById('country-egypt').textContent = texts.egypt || 'Egypt';
            document.getElementById('country-turkey').textContent = texts.turkey || 'Turkey';
            document.getElementById('country-other').textContent = texts.other || 'Other';
        }

        // Apply translations on page load
        applyTranslations();

        // Form event handlers
        skipBtn.addEventListener('click', () => {
            console.log('User clicked Skip');
            startLocationVerification();
        });

        continueBtn.addEventListener('click', () => {
            // Collect form data
            businessData.businessName = businessNameInput.value.trim();
            businessData.country = countrySelect.value;
            businessData.email = emailInput.value.trim();

            console.log('Business data collected:', businessData);
            startLocationVerification();
        });

        function startLocationVerification() {
            // Hide form, show loading
            businessForm.classList.add('hidden');
            loadingState.classList.remove('hidden');
            requestLocation();
        }

        // Function to check if location is in Syria (approximate bounds)
        function isLocationInSyria(lat, lon) {
            // Syria approximate bounds: 32.3° to 37.3° N, 35.6° to 42.4° E
            return lat >= 32.3 && lat <= 37.3 && lon >= 35.6 && lon <= 42.4;
        }

        // Function to show success state
        function showSuccess(latitude, longitude, accuracy) {
            // Check if location is in Syria (for now, accept any location as mock)
            const isInSyria = true; // Mock: accept all locations for Syria
            // const isInSyria = isLocationInSyria(latitude, longitude); // Real check

            if (!isInSyria) {
                showError('location_not_syria');
                return;
            }

            loadingState.classList.add('hidden');
            successState.classList.remove('hidden');
            errorState.classList.add('hidden');

            if (window.Telegram && window.Telegram.WebApp) {
                const dataToSend = JSON.stringify({
                    verified: true,
                    latitude,
                    longitude,
                    accuracy: accuracy ?? null,
                    ts: Date.now(),
                    ...businessData // Include business data
                });

                console.log('Mini App: Sending success data:', dataToSend);
                window.Telegram.WebApp.sendData(dataToSend);
                // Ensure WebApp closes after sending data
                setTimeout(() => {
                    window.Telegram.WebApp.close();
                }, 500);
            } else {
                console.error('Mini App: Telegram WebApp not available!');
            }
        }

        // Function to show error state
        function showError(reason = "geo_error") {
            loadingState.classList.add('hidden');
            successState.classList.add('hidden');
            errorState.classList.remove('hidden');

            if (window.Telegram && window.Telegram.WebApp) {
                const dataToSend = JSON.stringify({
                    verified: false,
                    reason,
                    ts: Date.now(),
                    ...businessData // Include business data even on failure
                });

                console.log('Mini App: Sending failure data:', dataToSend);
                window.Telegram.WebApp.sendData(dataToSend);
                // Ensure WebApp closes after sending data
                setTimeout(() => {
                    window.Telegram.WebApp.close();
                }, 500);
            } else {
                console.error('Mini App: Telegram WebApp not available!');
            }
        }

        // Function to request location
        function requestLocation() {
            if (!navigator.geolocation) {
                console.error('Geolocation is not supported by this browser');
                showError();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    showSuccess(latitude, longitude, position.coords.accuracy);
                },
                (error) => {
                    console.error('Error getting location:', error);
                    showError(error.code ? `geo_${error.code}` : "geo_error");
                }
            );
        }

        // Form is shown by default, user clicks Continue or Skip to proceed
    </script>
</body>
</html>
